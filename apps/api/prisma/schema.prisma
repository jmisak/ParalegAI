// =============================================================================
// IRONCLAD - AI-Powered Paralegal Assistant for Real Estate Law
// Prisma Schema Definition
// =============================================================================
// This schema defines the complete data model for IRONCLAD, a multi-tenant
// legal practice management system specialized for real estate law.
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "fullTextSearchPostgres"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector"), uuid_ossp(map: "uuid-ossp")]
}

// =============================================================================
// ENUMS - Status and Type Definitions
// =============================================================================

/// User roles within an organization
enum UserRole {
  ADMIN // Full system access
  ATTORNEY // Licensed attorney
  PARALEGAL // Paralegal staff
  LEGAL_ASSISTANT // Legal assistant
  ACCOUNTANT // Trust accounting access
  VIEWER // Read-only access

  @@map("user_role")
}

/// Matter/case status lifecycle
enum MatterStatus {
  INTAKE // Initial client intake
  ACTIVE // Currently being worked
  PENDING // Awaiting external action
  ON_HOLD // Temporarily paused
  CLOSING // In closing process
  CLOSED // Completed
  ARCHIVED // Long-term storage

  @@map("matter_status")
}

/// Types of real estate transactions
enum TransactionType {
  PURCHASE // Property purchase
  SALE // Property sale
  REFINANCE // Mortgage refinance
  LEASE // Commercial/residential lease
  LEASE_OPTION // Lease with purchase option
  EXCHANGE_1031 // Tax-deferred exchange
  FORECLOSURE // Foreclosure proceedings
  SHORT_SALE // Short sale transaction
  TITLE_ONLY // Title work only
  OPINION_LETTER // Title opinion
  EASEMENT // Easement creation/modification
  SUBDIVISION // Property subdivision
  CONDOMINIUM // Condo creation/conversion

  @@map("transaction_type")
}

/// Property types
enum PropertyType {
  SINGLE_FAMILY // Single family residence
  MULTI_FAMILY // Multi-family (2-4 units)
  CONDOMINIUM // Condominium unit
  TOWNHOUSE // Townhouse
  COMMERCIAL // Commercial property
  INDUSTRIAL // Industrial property
  MIXED_USE // Mixed use property
  VACANT_LAND // Undeveloped land
  AGRICULTURAL // Farm/agricultural
  SPECIAL_PURPOSE // Special purpose (church, school, etc.)

  @@map("property_type")
}

/// Party types in a transaction
enum PartyType {
  INDIVIDUAL // Natural person
  MARRIED_COUPLE // Married couple (joint)
  CORPORATION // Corporation
  LLC // Limited Liability Company
  PARTNERSHIP // General or Limited Partnership
  TRUST // Trust entity
  ESTATE // Estate of deceased
  GOVERNMENT // Government entity
  NON_PROFIT // Non-profit organization
  JOINT_VENTURE // Joint venture

  @@map("party_type")
}

/// Party roles in a matter
enum PartyRole {
  BUYER // Purchaser
  SELLER // Vendor
  BORROWER // Loan borrower
  LENDER // Financial institution
  LANDLORD // Property lessor
  TENANT // Property lessee
  GUARANTOR // Loan guarantor
  TITLE_COMPANY // Title insurance company
  ESCROW_AGENT // Escrow holder
  SURVEYOR // Land surveyor
  APPRAISER // Property appraiser
  INSPECTOR // Property inspector
  REAL_ESTATE_AGENT // Realtor/broker
  ATTORNEY // Opposing counsel
  WITNESS // Document witness
  NOTARY // Notary public
  OTHER // Other party type

  @@map("party_role")
}

/// Document status in workflow
enum DocumentStatus {
  DRAFT // Being drafted
  PENDING_REVIEW // Awaiting review
  APPROVED // Approved for use
  EXECUTED // Signed/executed
  RECORDED // Recorded with county
  SUPERSEDED // Replaced by newer version
  VOIDED // Cancelled/voided
  ARCHIVED // Archived

  @@map("document_status")
}

/// Task status
enum TaskStatus {
  NOT_STARTED // Not yet begun
  IN_PROGRESS // Currently being worked
  BLOCKED // Blocked by dependency
  PENDING_REVIEW // Awaiting review
  COMPLETED // Finished
  CANCELLED // Cancelled

  @@map("task_status")
}

/// Task priority levels
enum TaskPriority {
  CRITICAL // Must complete immediately
  HIGH // High priority
  MEDIUM // Normal priority
  LOW // Low priority

  @@map("task_priority")
}

/// Deadline types with calculation rules
enum DeadlineType {
  STATUTORY // Required by law
  CONTRACTUAL // Per contract terms
  COURT_ORDERED // Court mandate
  INTERNAL // Firm internal deadline
  REMINDER // Soft reminder

  @@map("deadline_type")
}

/// Communication channels
enum CommunicationChannel {
  EMAIL // Email correspondence
  PHONE // Phone call
  SMS // Text message
  PORTAL // Client portal message
  IN_PERSON // In-person meeting
  VIDEO_CALL // Video conference
  FAX // Fax transmission
  MAIL // Physical mail

  @@map("communication_channel")
}

/// Communication direction
enum CommunicationDirection {
  INBOUND // Received
  OUTBOUND // Sent
  INTERNAL // Internal communication

  @@map("communication_direction")
}

/// Trust transaction types
enum TrustTransactionType {
  DEPOSIT // Funds deposited
  DISBURSEMENT // Funds disbursed
  TRANSFER // Internal transfer
  INTEREST // Interest earned
  FEE // Bank/service fee
  ADJUSTMENT // Balance adjustment
  REFUND // Refund issued

  @@map("trust_transaction_type")
}

/// Encumbrance types
enum EncumbranceType {
  MORTGAGE // Mortgage lien
  DEED_OF_TRUST // Deed of trust
  MECHANICS_LIEN // Mechanics/materialman lien
  TAX_LIEN // Property tax lien
  JUDGMENT_LIEN // Court judgment lien
  HOA_LIEN // HOA assessment lien
  EASEMENT // Easement
  RESTRICTION // Deed restriction
  COVENANT // Restrictive covenant
  LEASE // Recorded lease
  LIS_PENDENS // Pending litigation notice
  UCC_FILING // UCC fixture filing
  OTHER // Other encumbrance

  @@map("encumbrance_type")
}

/// Compliance check types
enum ComplianceCheckType {
  IDENTITY_VERIFICATION // KYC/AML identity check
  SANCTIONS_SCREENING // OFAC/sanctions list
  BENEFICIAL_OWNERSHIP // FinCEN BOI reporting
  CONFLICT_CHECK // Conflict of interest
  BAR_STANDING // Attorney bar standing
  LICENSE_VERIFICATION // Professional license
  INSURANCE_VERIFICATION // Insurance coverage
  DOCUMENT_REVIEW // Document compliance

  @@map("compliance_check_type")
}

/// Compliance check status
enum ComplianceCheckStatus {
  PENDING // Not yet performed
  IN_PROGRESS // Currently checking
  PASSED // Passed verification
  FAILED // Failed verification
  FLAGGED // Requires review
  EXPIRED // Check expired
  WAIVED // Waived by authority

  @@map("compliance_check_status")
}

/// Audit log action types
enum AuditAction {
  CREATE // Record created
  READ // Record accessed
  UPDATE // Record modified
  DELETE // Record deleted
  EXPORT // Data exported
  LOGIN // User logged in
  LOGOUT // User logged out
  PERMISSION_CHANGE // Permissions modified
  STATUS_CHANGE // Status changed
  ASSIGNMENT_CHANGE // Assignment modified

  @@map("audit_action")
}

/// Workflow status
enum WorkflowStatus {
  DRAFT // Being designed
  ACTIVE // Available for use
  DEPRECATED // No longer preferred
  ARCHIVED // No longer available

  @@map("workflow_status")
}

// =============================================================================
// CORE ENTITIES
// =============================================================================

/// Organization represents a law firm or legal department (tenant)
model Organization {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Firm name
  name String @db.VarChar(255)

  /// URL-safe identifier
  slug String @unique @db.VarChar(100)

  /// Primary contact email
  email String @db.VarChar(255)

  /// Primary phone number
  phone String? @db.VarChar(50)

  /// Firm website
  website String? @db.VarChar(255)

  /// Physical address as structured JSON
  address Json? @db.JsonB

  /// Firm logo URL
  logoUrl String? @map("logo_url") @db.VarChar(500)

  /// Subscription tier
  subscriptionTier String @default("standard") @map("subscription_tier") @db.VarChar(50)

  /// Subscription status
  subscriptionStatus String @default("active") @map("subscription_status") @db.VarChar(50)

  /// Organization-wide settings
  settings Json @default("{}") @db.JsonB

  /// Jurisdictions the firm operates in
  jurisdictions String[] @default([]) @db.VarChar(50)

  /// IOLTA trust account information
  trustAccountInfo Json? @map("trust_account_info") @db.JsonB

  // Relations
  users             User[]
  matters           Matter[]
  parties           Party[]
  documents         Document[]
  documentTemplates DocumentTemplate[]
  workflows         Workflow[]
  auditLogs         AuditLog[]
  trustTransactions TrustTransaction[]

  @@index([slug])
  @@index([deletedAt])
  @@map("organizations")
}

/// User represents a system user (attorney, paralegal, staff)
model User {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  /// Email address (unique within organization)
  email String @db.VarChar(255)

  /// Hashed password
  passwordHash String? @map("password_hash") @db.VarChar(255)

  /// First name
  firstName String @map("first_name") @db.VarChar(100)

  /// Last name
  lastName String @map("last_name") @db.VarChar(100)

  /// Display name
  displayName String? @map("display_name") @db.VarChar(200)

  /// Profile photo URL
  avatarUrl String? @map("avatar_url") @db.VarChar(500)

  /// Phone number
  phone String? @db.VarChar(50)

  /// User role
  role UserRole @default(PARALEGAL)

  /// Bar number (for attorneys)
  barNumber String? @map("bar_number") @db.VarChar(50)

  /// State bar membership
  barState String? @map("bar_state") @db.VarChar(50)

  /// All jurisdictions user is licensed in
  jurisdictions String[] @default([]) @db.VarChar(50)

  /// Account active status
  isActive Boolean @default(true) @map("is_active")

  /// Email verified status
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")

  /// Last login timestamp
  lastLoginAt DateTime? @map("last_login_at")

  /// User preferences (theme, notifications, etc.)
  preferences Json @default("{}") @db.JsonB

  /// Multi-factor authentication enabled
  mfaEnabled Boolean @default(false) @map("mfa_enabled")

  /// MFA secret (encrypted)
  mfaSecret String? @map("mfa_secret") @db.VarChar(255)

  // Relations
  mattersResponsible Matter[]          @relation("ResponsibleAttorney")
  mattersOriginating Matter[]          @relation("OriginatingAttorney")
  taskAssignments    TaskAssignment[]
  timeEntries        TimeEntry[]
  communications     Communication[]
  auditLogs          AuditLog[]
  documentVersions   DocumentVersion[] @relation("VersionCreator")

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@index([deletedAt])
  @@map("users")
}

/// Matter represents a legal case or file
model Matter {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  /// Firm's internal file number
  fileNumber String @map("file_number") @db.VarChar(50)

  /// Matter display name/title
  name String @db.VarChar(255)

  /// Detailed description
  description String? @db.Text

  /// Current status
  status MatterStatus @default(INTAKE)

  /// Type of transaction
  transactionType TransactionType @map("transaction_type")

  /// Target closing date
  targetClosingDate DateTime? @map("target_closing_date") @db.Date

  /// Actual closing date
  actualClosingDate DateTime? @map("actual_closing_date") @db.Date

  /// Responsible attorney
  responsibleAttorneyId String? @map("responsible_attorney_id") @db.Uuid
  responsibleAttorney   User?   @relation("ResponsibleAttorney", fields: [responsibleAttorneyId], references: [id])

  /// Originating attorney (for referral tracking)
  originatingAttorneyId String? @map("originating_attorney_id") @db.Uuid
  originatingAttorney   User?   @relation("OriginatingAttorney", fields: [originatingAttorneyId], references: [id])

  /// Jurisdiction (state)
  jurisdiction String @db.VarChar(50)

  /// County
  county String? @db.VarChar(100)

  /// Matter-specific settings and custom fields
  metadata Json @default("{}") @db.JsonB

  /// Billing rate overrides
  billingRates Json? @map("billing_rates") @db.JsonB

  /// Conflict check completed
  conflictCheckCompleted Boolean   @default(false) @map("conflict_check_completed")
  conflictCheckDate      DateTime? @map("conflict_check_date")

  /// Engagement letter signed
  engagementSigned Boolean   @default(false) @map("engagement_signed")
  engagementDate   DateTime? @map("engagement_date")

  // Relations
  property          Property?
  transaction       Transaction?
  matterParties     MatterParty[]
  documents         Document[]
  deadlines         Deadline[]
  tasks             Task[]
  timeEntries       TimeEntry[]
  communications    Communication[]
  trustTransactions TrustTransaction[]
  complianceChecks  ComplianceCheck[]
  auditLogs         AuditLog[]
  workflowInstances WorkflowInstance[]

  @@unique([organizationId, fileNumber])
  @@index([organizationId])
  @@index([status])
  @@index([transactionType])
  @@index([responsibleAttorneyId])
  @@index([targetClosingDate])
  @@index([deletedAt])
  @@map("matters")
}

/// Property represents a real estate parcel
model Property {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized for query performance)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated matter
  matterId String @unique @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// Property type
  propertyType PropertyType @map("property_type")

  /// Street address
  streetAddress String @map("street_address") @db.VarChar(255)

  /// Unit/suite number
  unitNumber String? @map("unit_number") @db.VarChar(50)

  /// City
  city String @db.VarChar(100)

  /// State
  state String @db.VarChar(50)

  /// ZIP code
  zipCode String @map("zip_code") @db.VarChar(20)

  /// County
  county String @db.VarChar(100)

  /// Full legal description
  legalDescription String? @map("legal_description") @db.Text

  /// Parcel/APN number
  parcelNumber String? @map("parcel_number") @db.VarChar(100)

  /// Tax map reference
  taxMapReference String? @map("tax_map_reference") @db.VarChar(100)

  /// Lot number
  lot String? @db.VarChar(50)

  /// Block number
  block String? @db.VarChar(50)

  /// Subdivision/plat name
  subdivision String? @db.VarChar(255)

  /// Section (for metes and bounds)
  section String? @db.VarChar(50)

  /// Township
  township String? @db.VarChar(50)

  /// Range
  range String? @db.VarChar(50)

  /// Acreage
  acreage Decimal? @db.Decimal(10, 4)

  /// Square footage
  squareFeet Int? @map("square_feet")

  /// Year built
  yearBuilt Int? @map("year_built")

  /// Number of units (for multi-family)
  units Int @default(1)

  /// Zoning classification
  zoning String? @db.VarChar(50)

  /// Current assessed value
  assessedValue Decimal? @map("assessed_value") @db.Decimal(15, 2)

  /// Tax year for assessed value
  assessedYear Int? @map("assessed_year")

  /// Annual property taxes
  annualTaxes Decimal? @map("annual_taxes") @db.Decimal(12, 2)

  /// HOA name
  hoaName String? @map("hoa_name") @db.VarChar(255)

  /// Monthly HOA dues
  hoaDues Decimal? @map("hoa_dues") @db.Decimal(10, 2)

  /// Survey date
  surveyDate DateTime? @map("survey_date") @db.Date

  /// Surveyor name
  surveyor String? @db.VarChar(255)

  /// Flood zone designation
  floodZone String? @map("flood_zone") @db.VarChar(50)

  /// Environmental concerns noted
  environmentalNotes String? @map("environmental_notes") @db.Text

  /// Additional property metadata
  metadata Json @default("{}") @db.JsonB

  /// Geocoded latitude
  latitude Decimal? @db.Decimal(10, 8)

  /// Geocoded longitude
  longitude Decimal? @db.Decimal(11, 8)

  // Relations
  titleRecords TitleRecord[]
  encumbrances Encumbrance[]

  @@index([organizationId])
  @@index([parcelNumber])
  @@index([state, county])
  @@index([deletedAt])
  @@map("properties")
}

/// Party represents an individual or entity involved in matters
model Party {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  /// Party type
  partyType PartyType @map("party_type")

  /// For individuals: first name
  firstName String? @map("first_name") @db.VarChar(100)

  /// For individuals: middle name
  middleName String? @map("middle_name") @db.VarChar(100)

  /// For individuals: last name / For entities: full name
  lastName String @map("last_name") @db.VarChar(255)

  /// Suffix (Jr., III, etc.)
  suffix String? @db.VarChar(20)

  /// Computed display name
  displayName String @map("display_name") @db.VarChar(300)

  /// Primary email
  email String? @db.VarChar(255)

  /// Primary phone
  phone String? @db.VarChar(50)

  /// Alternate phone
  altPhone String? @map("alt_phone") @db.VarChar(50)

  /// Fax number
  fax String? @db.VarChar(50)

  /// Mailing address
  mailingAddress Json? @map("mailing_address") @db.JsonB

  /// For individuals: date of birth
  dateOfBirth DateTime? @map("date_of_birth") @db.Date

  /// SSN/EIN (encrypted at rest)
  taxId String? @map("tax_id") @db.VarChar(50)

  /// For entities: state of formation
  stateOfFormation String? @map("state_of_formation") @db.VarChar(50)

  /// For entities: entity ID number
  entityNumber String? @map("entity_number") @db.VarChar(100)

  /// For entities: date of formation
  dateOfFormation DateTime? @map("date_of_formation") @db.Date

  /// For trusts: trust date
  trustDate DateTime? @map("trust_date") @db.Date

  /// For trusts: trustee names
  trustees String[] @default([]) @db.VarChar(255)

  /// Marital status (for individuals)
  maritalStatus String? @map("marital_status") @db.VarChar(50)

  /// Spouse party reference (for married individuals)
  spouseId String? @map("spouse_id") @db.Uuid

  /// US citizen status
  usCitizen Boolean? @map("us_citizen")

  /// Notes about the party
  notes String? @db.Text

  /// KYC/AML verification completed
  identityVerified   Boolean   @default(false) @map("identity_verified")
  identityVerifiedAt DateTime? @map("identity_verified_at")

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  matterParties     MatterParty[]
  trustTransactions TrustTransaction[]

  @@index([organizationId])
  @@index([partyType])
  @@index([lastName])
  @@index([email])
  @@index([deletedAt])
  @@map("parties")
}

/// MatterParty is a junction table linking parties to matters with roles
model MatterParty {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// The matter
  matterId String @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// The party
  partyId String @map("party_id") @db.Uuid
  party   Party  @relation(fields: [partyId], references: [id], onDelete: Cascade)

  /// Role in this matter
  role PartyRole

  /// Is this the primary party of this role type?
  isPrimary Boolean @default(false) @map("is_primary")

  /// Represented by our firm?
  isClient Boolean @default(false) @map("is_client")

  /// Party-specific notes for this matter
  notes String? @db.Text

  /// Role-specific metadata
  metadata Json @default("{}") @db.JsonB

  @@unique([matterId, partyId, role])
  @@index([organizationId])
  @@index([matterId])
  @@index([partyId])
  @@index([role])
  @@index([deletedAt])
  @@map("matter_parties")
}

/// Transaction contains financial details for a real estate transaction
model Transaction {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated matter
  matterId String @unique @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// Purchase/sale price
  purchasePrice Decimal? @map("purchase_price") @db.Decimal(15, 2)

  /// Earnest money amount
  earnestMoney Decimal? @map("earnest_money") @db.Decimal(12, 2)

  /// Earnest money holder
  earnestMoneyHolder String? @map("earnest_money_holder") @db.VarChar(255)

  /// Contract date
  contractDate DateTime? @map("contract_date") @db.Date

  /// Contract deadline dates stored as JSON
  contractDeadlines Json? @map("contract_deadlines") @db.JsonB

  /// Financing type (conventional, FHA, VA, cash, etc.)
  financingType String? @map("financing_type") @db.VarChar(50)

  /// Loan amount
  loanAmount Decimal? @map("loan_amount") @db.Decimal(15, 2)

  /// Interest rate
  interestRate Decimal? @map("interest_rate") @db.Decimal(5, 3)

  /// Loan term in months
  loanTermMonths Int? @map("loan_term_months")

  /// Loan type (fixed, ARM, etc.)
  loanType String? @map("loan_type") @db.VarChar(50)

  /// Down payment amount
  downPayment Decimal? @map("down_payment") @db.Decimal(15, 2)

  /// Seller concessions
  sellerConcessions Decimal? @map("seller_concessions") @db.Decimal(12, 2)

  /// Commission details
  commissionDetails Json? @map("commission_details") @db.JsonB

  /// Title insurance premium
  titleInsurancePremium Decimal? @map("title_insurance_premium") @db.Decimal(12, 2)

  /// Owner's title policy amount
  ownersPolicyAmount Decimal? @map("owners_policy_amount") @db.Decimal(15, 2)

  /// Lender's title policy amount
  lendersPolicyAmount Decimal? @map("lenders_policy_amount") @db.Decimal(15, 2)

  /// Recording fees
  recordingFees Decimal? @map("recording_fees") @db.Decimal(10, 2)

  /// Transfer tax
  transferTax Decimal? @map("transfer_tax") @db.Decimal(12, 2)

  /// Survey cost
  surveyCost Decimal? @map("survey_cost") @db.Decimal(10, 2)

  /// Inspection cost
  inspectionCost Decimal? @map("inspection_cost") @db.Decimal(10, 2)

  /// Proration date
  prorationDate DateTime? @map("proration_date") @db.Date

  /// Tax proration amount
  taxProration Decimal? @map("tax_proration") @db.Decimal(12, 2)

  /// Rent proration amount (for income property)
  rentProration Decimal? @map("rent_proration") @db.Decimal(12, 2)

  /// HOA proration
  hoaProration Decimal? @map("hoa_proration") @db.Decimal(10, 2)

  /// Additional fees as JSON array
  additionalFees Json? @map("additional_fees") @db.JsonB

  /// Settlement statement data (HUD/ALTA)
  settlementData Json? @map("settlement_data") @db.JsonB

  /// Wire transfer instructions (encrypted)
  wireInstructions Json? @map("wire_instructions") @db.JsonB

  /// For 1031 exchanges: exchange details
  exchangeDetails Json? @map("exchange_details") @db.JsonB

  /// For leases: monthly rent
  monthlyRent Decimal? @map("monthly_rent") @db.Decimal(12, 2)

  /// For leases: security deposit
  securityDeposit Decimal? @map("security_deposit") @db.Decimal(12, 2)

  /// For leases: lease term in months
  leaseTermMonths Int? @map("lease_term_months")

  /// For leases: lease start date
  leaseStartDate DateTime? @map("lease_start_date") @db.Date

  /// For leases: lease end date
  leaseEndDate DateTime? @map("lease_end_date") @db.Date

  /// Additional transaction metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([deletedAt])
  @@map("transactions")
}

// =============================================================================
// DOCUMENT ENTITIES
// =============================================================================

/// Document represents a legal document
model Document {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  /// Associated matter (optional for templates)
  matterId String? @map("matter_id") @db.Uuid
  matter   Matter? @relation(fields: [matterId], references: [id], onDelete: SetNull)

  /// Document title
  title String @db.VarChar(500)

  /// Document description
  description String? @db.Text

  /// Document category/type
  documentType String @map("document_type") @db.VarChar(100)

  /// Current status
  status DocumentStatus @default(DRAFT)

  /// Current version number
  currentVersion Int @default(1) @map("current_version")

  /// MIME type
  mimeType String @map("mime_type") @db.VarChar(100)

  /// File size in bytes
  fileSize BigInt? @map("file_size")

  /// Storage path/key
  storagePath String @map("storage_path") @db.VarChar(1000)

  /// Storage bucket/container
  storageBucket String @map("storage_bucket") @db.VarChar(255)

  /// Original filename
  originalFilename String @map("original_filename") @db.VarChar(500)

  /// File hash for integrity
  fileHash String? @map("file_hash") @db.VarChar(128)

  /// Generated from template
  templateId String? @map("template_id") @db.Uuid

  /// Tags for categorization
  tags String[] @default([]) @db.VarChar(50)

  /// Recording information
  recordingNumber String?   @map("recording_number") @db.VarChar(100)
  recordingDate   DateTime? @map("recording_date") @db.Date
  recordingBook   String?   @map("recording_book") @db.VarChar(50)
  recordingPage   String?   @map("recording_page") @db.VarChar(50)

  /// Execution details
  executedDate DateTime? @map("executed_date") @db.Date
  executedBy   String[]  @default([]) @map("executed_by") @db.VarChar(255)

  /// Document metadata (extracted text, entities, etc.)
  metadata Json @default("{}") @db.JsonB

  /// OCR/extracted text for search
  extractedText String? @map("extracted_text") @db.Text

  /// AI-generated summary
  summary String? @db.Text

  // Relations
  versions DocumentVersion[]
  chunks   DocumentChunk[]

  @@index([organizationId])
  @@index([matterId])
  @@index([documentType])
  @@index([status])
  @@index([tags], type: Gin)
  @@index([deletedAt])
  @@map("documents")
}

/// DocumentVersion stores immutable versions of documents
model DocumentVersion {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Parent document
  documentId String   @map("document_id") @db.Uuid
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  /// Version number
  versionNumber Int @map("version_number")

  /// Who created this version
  createdById String @map("created_by_id") @db.Uuid
  createdBy   User   @relation("VersionCreator", fields: [createdById], references: [id])

  /// Storage path for this version
  storagePath String @map("storage_path") @db.VarChar(1000)

  /// File size
  fileSize BigInt @map("file_size")

  /// File hash
  fileHash String @map("file_hash") @db.VarChar(128)

  /// Change description
  changeDescription String? @map("change_description") @db.Text

  /// Version metadata
  metadata Json @default("{}") @db.JsonB

  @@unique([documentId, versionNumber])
  @@index([organizationId])
  @@index([documentId])
  @@map("document_versions")
}

/// DocumentTemplate stores reusable document templates
model DocumentTemplate {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  /// Template name
  name String @db.VarChar(255)

  /// Template description
  description String? @db.Text

  /// Document type this template creates
  documentType String @map("document_type") @db.VarChar(100)

  /// Transaction types this template applies to
  transactionTypes TransactionType[] @map("transaction_types")

  /// Jurisdictions this template is valid for
  jurisdictions String[] @default([]) @db.VarChar(50)

  /// Template category
  category String? @db.VarChar(100)

  /// Template content/path
  templatePath String @map("template_path") @db.VarChar(1000)

  /// Template format (docx, pdf, html)
  templateFormat String @map("template_format") @db.VarChar(20)

  /// Variable definitions for the template
  variables Json @default("[]") @db.JsonB

  /// Current version
  version Int @default(1)

  /// Is this the system default for its type?
  isDefault Boolean @default(false) @map("is_default")

  /// Is this template active?
  isActive Boolean @default(true) @map("is_active")

  /// Template metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([documentType])
  @@index([transactionTypes], type: Gin)
  @@index([jurisdictions], type: Gin)
  @@index([isActive])
  @@index([deletedAt])
  @@map("document_templates")
}

/// DocumentChunk stores vector embeddings for RAG
model DocumentChunk {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Parent document
  documentId String   @map("document_id") @db.Uuid
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  /// Chunk sequence number
  chunkIndex Int @map("chunk_index")

  /// The text content of this chunk
  content String @db.Text

  /// Token count
  tokenCount Int @map("token_count")

  /// Start character position in source
  startPosition Int @map("start_position")

  /// End character position in source
  endPosition Int @map("end_position")

  /// Vector embedding (1536 dimensions for OpenAI ada-002)
  embedding Unsupported("vector(1536)")?

  /// Chunk metadata (page number, section, etc.)
  metadata Json @default("{}") @db.JsonB

  @@unique([documentId, chunkIndex])
  @@index([organizationId])
  @@index([documentId])
  @@map("document_chunks")
}

// =============================================================================
// WORKFLOW ENTITIES
// =============================================================================

/// Deadline tracks important dates and deadlines
model Deadline {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated matter
  matterId String @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// Deadline title
  title String @db.VarChar(255)

  /// Detailed description
  description String? @db.Text

  /// Deadline type
  deadlineType DeadlineType @map("deadline_type")

  /// Due date and time
  dueDate DateTime @map("due_date")

  /// Is this an all-day deadline?
  allDay Boolean @default(true) @map("all_day")

  /// Days before to send reminder
  reminderDays Int[] @default([1, 3, 7]) @map("reminder_days")

  /// Has reminder been sent?
  reminderSent Boolean @default(false) @map("reminder_sent")

  /// Is deadline completed?
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")

  /// Source of deadline (contract clause, statute, etc.)
  source String? @db.VarChar(255)

  /// Calculation rule for auto-computed deadlines
  calculationRule Json? @map("calculation_rule") @db.JsonB

  /// Priority
  priority TaskPriority @default(MEDIUM)

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  tasks Task[]

  @@index([organizationId])
  @@index([matterId])
  @@index([dueDate])
  @@index([completed])
  @@index([deadlineType])
  @@index([deletedAt])
  @@map("deadlines")
}

/// Task represents a work item
model Task {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated matter
  matterId String @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// Associated deadline (optional)
  deadlineId String?   @map("deadline_id") @db.Uuid
  deadline   Deadline? @relation(fields: [deadlineId], references: [id], onDelete: SetNull)

  /// Workflow instance (if part of workflow)
  workflowInstanceId String?           @map("workflow_instance_id") @db.Uuid
  workflowInstance   WorkflowInstance? @relation(fields: [workflowInstanceId], references: [id], onDelete: SetNull)

  /// Workflow step (if part of workflow)
  workflowStepId String?       @map("workflow_step_id") @db.Uuid
  workflowStep   WorkflowStep? @relation(fields: [workflowStepId], references: [id], onDelete: SetNull)

  /// Task title
  title String @db.VarChar(255)

  /// Detailed description
  description String? @db.Text

  /// Current status
  status TaskStatus @default(NOT_STARTED)

  /// Priority
  priority TaskPriority @default(MEDIUM)

  /// Due date
  dueDate DateTime? @map("due_date")

  /// Estimated hours
  estimatedHours Decimal? @map("estimated_hours") @db.Decimal(5, 2)

  /// Actual hours spent
  actualHours Decimal? @map("actual_hours") @db.Decimal(5, 2)

  /// Task category
  category String? @db.VarChar(100)

  /// Tags
  tags String[] @default([]) @db.VarChar(50)

  /// Started timestamp
  startedAt DateTime? @map("started_at")

  /// Completed timestamp
  completedAt DateTime? @map("completed_at")

  /// Task dependencies (IDs of tasks that must complete first)
  dependencies String[] @default([]) @db.Uuid

  /// Order for sorting
  sortOrder Int @default(0) @map("sort_order")

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  assignments TaskAssignment[]

  @@index([organizationId])
  @@index([matterId])
  @@index([deadlineId])
  @@index([workflowInstanceId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([deletedAt])
  @@map("tasks")
}

/// TaskAssignment links tasks to users
model TaskAssignment {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// The task
  taskId String @map("task_id") @db.Uuid
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  /// Assigned user
  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Is this the primary assignee?
  isPrimary Boolean @default(false) @map("is_primary")

  /// Assignment notes
  notes String? @db.Text

  @@unique([taskId, userId])
  @@index([organizationId])
  @@index([taskId])
  @@index([userId])
  @@index([deletedAt])
  @@map("task_assignments")
}

/// Workflow defines a reusable process template
model Workflow {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  /// Workflow name
  name String @db.VarChar(255)

  /// Workflow description
  description String? @db.Text

  /// Transaction types this workflow applies to
  transactionTypes TransactionType[] @map("transaction_types")

  /// Jurisdictions this workflow is valid for
  jurisdictions String[] @default([]) @db.VarChar(50)

  /// Workflow status
  status WorkflowStatus @default(DRAFT)

  /// Current version
  version Int @default(1)

  /// Is this the default workflow for its type?
  isDefault Boolean @default(false) @map("is_default")

  /// Workflow configuration/settings
  config Json @default("{}") @db.JsonB

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  steps     WorkflowStep[]
  instances WorkflowInstance[]

  @@index([organizationId])
  @@index([transactionTypes], type: Gin)
  @@index([status])
  @@index([deletedAt])
  @@map("workflows")
}

/// WorkflowStep defines a step within a workflow
model WorkflowStep {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Parent workflow
  workflowId String   @map("workflow_id") @db.Uuid
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  /// Step name
  name String @db.VarChar(255)

  /// Step description
  description String? @db.Text

  /// Step type (task, decision, notification, etc.)
  stepType String @map("step_type") @db.VarChar(50)

  /// Order in workflow
  sortOrder Int @map("sort_order")

  /// IDs of steps that must complete before this one
  dependsOn String[] @default([]) @map("depends_on") @db.Uuid

  /// Default assignee role
  assigneeRole UserRole? @map("assignee_role")

  /// Estimated duration in hours
  estimatedHours Decimal? @map("estimated_hours") @db.Decimal(5, 2)

  /// Deadline calculation rule
  deadlineRule Json? @map("deadline_rule") @db.JsonB

  /// Step configuration
  config Json @default("{}") @db.JsonB

  /// Is this step required?
  isRequired Boolean @default(true) @map("is_required")

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  tasks Task[]

  @@index([organizationId])
  @@index([workflowId])
  @@index([sortOrder])
  @@index([deletedAt])
  @@map("workflow_steps")
}

/// WorkflowInstance is an active instance of a workflow on a matter
model WorkflowInstance {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// The workflow template
  workflowId String   @map("workflow_id") @db.Uuid
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Restrict)

  /// The matter this instance is for
  matterId String @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// Instance status
  status String @default("active") @db.VarChar(50)

  /// Started timestamp
  startedAt DateTime @default(now()) @map("started_at")

  /// Completed timestamp
  completedAt DateTime? @map("completed_at")

  /// Current step IDs (for parallel execution)
  currentSteps String[] @default([]) @map("current_steps") @db.Uuid

  /// Completed step IDs
  completedSteps String[] @default([]) @map("completed_steps") @db.Uuid

  /// Instance-specific data
  instanceData Json @default("{}") @map("instance_data") @db.JsonB

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  tasks Task[]

  @@index([organizationId])
  @@index([workflowId])
  @@index([matterId])
  @@index([status])
  @@index([deletedAt])
  @@map("workflow_instances")
}

// =============================================================================
// SUPPORTING ENTITIES
// =============================================================================

/// Communication tracks all communications related to a matter
model Communication {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated matter
  matterId String @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// User who created/logged this communication
  userId String? @map("user_id") @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// Communication channel
  channel CommunicationChannel

  /// Direction
  direction CommunicationDirection

  /// Subject line
  subject String? @db.VarChar(500)

  /// Communication content/summary
  content String @db.Text

  /// Participants (email addresses, phone numbers, names)
  participants String[] @default([]) @db.VarChar(255)

  /// External reference (email message ID, call SID, etc.)
  externalId String? @map("external_id") @db.VarChar(255)

  /// When the communication occurred
  occurredAt DateTime @map("occurred_at")

  /// Duration in seconds (for calls)
  durationSeconds Int? @map("duration_seconds")

  /// Attachment references
  attachments Json @default("[]") @db.JsonB

  /// Is this communication privileged?
  isPrivileged Boolean @default(false) @map("is_privileged")

  /// Is this billable time?
  isBillable Boolean @default(false) @map("is_billable")

  /// Associated time entry ID
  timeEntryId String? @map("time_entry_id") @db.Uuid

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([matterId])
  @@index([userId])
  @@index([channel])
  @@index([occurredAt])
  @@index([deletedAt])
  @@map("communications")
}

/// TimeEntry tracks billable and non-billable time
model TimeEntry {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated matter
  matterId String @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// User who performed the work
  userId String? @map("user_id") @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// Date of work
  workDate DateTime @map("work_date") @db.Date

  /// Hours worked (in decimal)
  hours Decimal @db.Decimal(5, 2)

  /// Billing rate
  rate Decimal @db.Decimal(10, 2)

  /// Total amount
  amount Decimal @db.Decimal(12, 2)

  /// Description of work
  description String @db.Text

  /// Activity code/category
  activityCode String? @map("activity_code") @db.VarChar(50)

  /// Is this billable?
  isBillable Boolean @default(true) @map("is_billable")

  /// Has this been billed?
  isBilled Boolean @default(false) @map("is_billed")

  /// Invoice ID if billed
  invoiceId String? @map("invoice_id") @db.Uuid

  /// Invoice date
  invoiceDate DateTime? @map("invoice_date") @db.Date

  /// Timer start (for active timing)
  timerStart DateTime? @map("timer_start")

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([matterId])
  @@index([userId])
  @@index([workDate])
  @@index([isBilled])
  @@index([deletedAt])
  @@map("time_entries")
}

/// TrustTransaction tracks escrow/IOLTA account transactions
model TrustTransaction {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  /// Associated matter
  matterId String @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Restrict)

  /// Associated party (whose funds)
  partyId String? @map("party_id") @db.Uuid
  party   Party?  @relation(fields: [partyId], references: [id], onDelete: SetNull)

  /// Transaction type
  transactionType TrustTransactionType @map("transaction_type")

  /// Transaction amount
  amount Decimal @db.Decimal(15, 2)

  /// Running balance after this transaction
  runningBalance Decimal @map("running_balance") @db.Decimal(15, 2)

  /// Transaction date
  transactionDate DateTime @map("transaction_date") @db.Date

  /// Check number (for disbursements)
  checkNumber String? @map("check_number") @db.VarChar(50)

  /// Payee/payor name
  payee String? @db.VarChar(255)

  /// Bank reference number
  bankReference String? @map("bank_reference") @db.VarChar(100)

  /// Description/memo
  description String @db.Text

  /// Has been reconciled
  isReconciled Boolean   @default(false) @map("is_reconciled")
  reconciledAt DateTime? @map("reconciled_at")

  /// Bank account identifier
  bankAccountId String @map("bank_account_id") @db.VarChar(100)

  /// Cleared date
  clearedDate DateTime? @map("cleared_date") @db.Date

  /// Voided
  isVoided   Boolean   @default(false) @map("is_voided")
  voidedAt   DateTime? @map("voided_at")
  voidReason String?   @map("void_reason") @db.Text

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([matterId])
  @@index([partyId])
  @@index([transactionType])
  @@index([transactionDate])
  @@index([isReconciled])
  @@index([deletedAt])
  @@map("trust_transactions")
}

/// TitleRecord tracks title search/examination records
model TitleRecord {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated property
  propertyId String   @map("property_id") @db.Uuid
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  /// Record type (deed, mortgage, easement, etc.)
  recordType String @map("record_type") @db.VarChar(100)

  /// Recording information
  recordingNumber String?   @map("recording_number") @db.VarChar(100)
  recordingDate   DateTime? @map("recording_date") @db.Date
  recordingBook   String?   @map("recording_book") @db.VarChar(50)
  recordingPage   String?   @map("recording_page") @db.VarChar(50)

  /// Instrument date
  instrumentDate DateTime? @map("instrument_date") @db.Date

  /// Grantor(s)
  grantors String[] @default([]) @db.VarChar(255)

  /// Grantee(s)
  grantees String[] @default([]) @db.VarChar(255)

  /// Consideration/amount
  consideration Decimal? @db.Decimal(15, 2)

  /// Legal description in this document
  legalDescription String? @map("legal_description") @db.Text

  /// Notes/exceptions
  notes String? @db.Text

  /// Document storage reference
  documentPath String? @map("document_path") @db.VarChar(1000)

  /// Search date
  searchDate DateTime @map("search_date") @db.Date

  /// Searched by
  searchedBy String? @map("searched_by") @db.VarChar(255)

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([propertyId])
  @@index([recordType])
  @@index([recordingDate])
  @@index([deletedAt])
  @@map("title_records")
}

/// Encumbrance tracks liens, easements, and other encumbrances
model Encumbrance {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated property
  propertyId String   @map("property_id") @db.Uuid
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  /// Encumbrance type
  encumbranceType EncumbranceType @map("encumbrance_type")

  /// Description
  description String @db.Text

  /// Holder/beneficiary
  holder String @db.VarChar(255)

  /// Original amount (for monetary liens)
  originalAmount Decimal? @map("original_amount") @db.Decimal(15, 2)

  /// Current balance (for monetary liens)
  currentBalance Decimal? @map("current_balance") @db.Decimal(15, 2)

  /// Recording information
  recordingNumber String?   @map("recording_number") @db.VarChar(100)
  recordingDate   DateTime? @map("recording_date") @db.Date

  /// Effective date
  effectiveDate DateTime? @map("effective_date") @db.Date

  /// Expiration/release date
  expirationDate DateTime? @map("expiration_date") @db.Date

  /// Priority position
  priorityPosition Int? @map("priority_position")

  /// Is this encumbrance cleared/released?
  isCleared        Boolean   @default(false) @map("is_cleared")
  clearedDate      DateTime? @map("cleared_date") @db.Date
  clearedReference String?   @map("cleared_reference") @db.VarChar(100)

  /// Title exception number (from commitment)
  exceptionNumber String? @map("exception_number") @db.VarChar(50)

  /// Notes
  notes String? @db.Text

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([propertyId])
  @@index([encumbranceType])
  @@index([isCleared])
  @@index([deletedAt])
  @@map("encumbrances")
}

/// ComplianceCheck tracks KYC/AML and other compliance verifications
model ComplianceCheck {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  /// Tenant isolation (denormalized)
  organizationId String @map("organization_id") @db.Uuid

  /// Associated matter
  matterId String @map("matter_id") @db.Uuid
  matter   Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)

  /// Check type
  checkType ComplianceCheckType @map("check_type")

  /// Subject of check (name, entity, etc.)
  subject String @db.VarChar(255)

  /// Subject identifier (SSN, EIN, etc. - encrypted)
  subjectIdentifier String? @map("subject_identifier") @db.VarChar(100)

  /// Check status
  status ComplianceCheckStatus @default(PENDING)

  /// Check performed date
  performedAt DateTime? @map("performed_at")

  /// Check expiration date
  expiresAt DateTime? @map("expires_at")

  /// Service/vendor used
  serviceName String? @map("service_name") @db.VarChar(100)

  /// External reference ID
  externalId String? @map("external_id") @db.VarChar(255)

  /// Result details
  resultDetails Json? @map("result_details") @db.JsonB

  /// Risk score
  riskScore Int? @map("risk_score")

  /// Flags/alerts
  flags String[] @default([]) @db.VarChar(100)

  /// Notes
  notes String? @db.Text

  /// Reviewed by
  reviewedBy String?   @map("reviewed_by") @db.VarChar(255)
  reviewedAt DateTime? @map("reviewed_at")

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([matterId])
  @@index([checkType])
  @@index([status])
  @@index([deletedAt])
  @@map("compliance_checks")
}

/// AuditLog tracks all system activity for compliance
model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  /// Tenant isolation
  organizationId String       @map("organization_id") @db.Uuid
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  /// User who performed the action
  userId String? @map("user_id") @db.Uuid
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// Associated matter (if applicable)
  matterId String? @map("matter_id") @db.Uuid
  matter   Matter? @relation(fields: [matterId], references: [id], onDelete: SetNull)

  /// Action performed
  action AuditAction

  /// Entity type affected
  entityType String @map("entity_type") @db.VarChar(100)

  /// Entity ID affected
  entityId String @map("entity_id") @db.Uuid

  /// Description of change
  description String @db.Text

  /// Previous values (for updates)
  previousValues Json? @map("previous_values") @db.JsonB

  /// New values (for creates/updates)
  newValues Json? @map("new_values") @db.JsonB

  /// IP address
  ipAddress String? @map("ip_address") @db.VarChar(45)

  /// User agent
  userAgent String? @map("user_agent") @db.VarChar(500)

  /// Session ID
  sessionId String? @map("session_id") @db.VarChar(255)

  /// Additional metadata
  metadata Json @default("{}") @db.JsonB

  @@index([organizationId])
  @@index([userId])
  @@index([matterId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
